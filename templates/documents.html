<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management - RAG System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .content {
            padding: 30px;
        }

        .stats-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .file-name {
            margin-left: 10px;
            color: #666;
        }

        .btn-upload {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-upload:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .btn-upload:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-progress {
            display: none;
            margin-top: 15px;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .progress-text {
            margin-top: 5px;
            font-size: 13px;
            color: #666;
        }

        .view-selector {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            border-color: #667eea;
            background: #f0f0ff;
            color: #667eea;
            font-weight: 600;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .document-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .document-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .document-card.selected {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .document-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            word-break: break-word;
            flex: 1;
        }

        .document-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-view:hover {
            background: #5568d3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .document-meta {
            display: grid;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
        }

        .meta-label {
            font-weight: 600;
        }

        .chunks-view {
            display: none;
        }

        .chunks-view.active {
            display: block;
        }

        .chunks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .chunks-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .btn-back {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        .chunks-list {
            display: grid;
            gap: 15px;
        }

        .chunk-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .chunk-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .chunk-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .chunk-id {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            word-break: break-all;
        }

        .chunk-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chunk-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 13px;
        }

        .metadata-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .metadata-label {
            font-weight: 600;
            color: #666;
            margin-right: 5px;
        }

        .metadata-value {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .supported-formats {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-edit:hover {
            background: #5568d3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 22px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            min-height: 150px;
            resize: vertical;
        }

        .form-textarea:focus {
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-results-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-results-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .search-results-count {
            font-size: 14px;
            color: #666;
        }

        .similarity-badge {
            display: inline-block;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .similarity-high {
            background: #28a745;
        }

        .similarity-medium {
            background: #ffc107;
        }

        .similarity-low {
            background: #dc3545;
        }

        .distance-info {
            font-size: 10px;
            color: #999;
            margin-left: 5px;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Document Management</h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="location.href='/'">← Back to Chat</button>
            </div>
        </div>

        <div class="content">
            <!-- Alert Messages -->
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>

            <!-- Search Section -->
            <div class="upload-section" style="border: 2px solid #667eea; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #333;">🔍 Search Documents & Chunks</h3>
                <div class="upload-area">
                    <div class="file-input-wrapper">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Search for documents or chunk content..."
                            style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; outline: none;"
                            onkeypress="handleSearchKeyPress(event)"
                        >
                    </div>
                    <select id="searchType" style="padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; outline: none; cursor: pointer;">
                        <option value="keyword">Keyword Search (substring)</option>
                        <option value="bm25">BM25 Search</option>
                        <option value="vector">Vector Search</option>
                    </select>
                    <button class="btn-upload" onclick="performSearch()">Search</button>
                    <button class="btn-upload" onclick="clearSearch()" style="background: #6c757d;">Clear</button>
                </div>
                <div class="supported-formats">
                    Keyword: exact substring • BM25: ranked keyword relevance • Vector: semantic similarity
                </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <h3 style="margin-bottom: 15px; color: #333;">📤 Upload New Document</h3>
                <div class="upload-area">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt,.md,.docx,.png,.jpg,.jpeg" onchange="handleFileSelect(event)">
                        <label for="fileInput" class="file-input-label">
                            📁 Choose File
                            <span class="file-name" id="fileName">No file selected</span>
                        </label>
                    </div>
                    <button class="btn-upload" id="uploadBtn" onclick="uploadDocument()" disabled>Upload & Process</button>
                </div>
                <div class="supported-formats">
                    Supported formats: PDF, TXT, MD, DOCX, PNG, JPG, JPEG
                </div>
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>
            </div>

            <!-- Retrieval Experimentation -->
            <div class="upload-section" style="border: 2px solid #28a745; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #333;">🧪 Retrieval Experimentation</h3>
                <div class="upload-area" style="align-items: flex-end; gap: 10px;">
                    <div class="file-input-wrapper">
                        <label class="form-label">Experiment Query</label>
                        <input
                            type="text"
                            id="expQueryInput"
                            placeholder="Enter a test query to simulate retrieval..."
                            style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; outline: none;"
                        >
                    </div>
                    <div>
                        <label class="form-label">Method</label>
                        <select id="expMethod" style="padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; outline: none; cursor: pointer;">
                            <option value="hybrid">Hybrid</option>
                            <option value="vector">Vector</option>
                            <option value="bm25">BM25</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Top K</label>
                        <input type="number" id="expTopK" value="20" min="1" max="200" style="width: 100px; padding: 12px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; outline: none;">
                    </div>
                    <button class="btn-upload" onclick="runExperimentRank()">Rank Selected Chunks</button>
                    <button class="btn-upload" style="background:#17a2b8" onclick="runExperimentSearch()">Run Search</button>
                </div>
                <div class="supported-formats" id="expSelectionInfo">Selected Chunks: <span id="selectedCount">0</span></div>
                <div id="expResults" style="margin-top: 15px;"></div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Total Documents</span>
                    <span class="stat-value" id="totalDocs">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Chunks</span>
                    <span class="stat-value" id="totalChunks">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Size</span>
                    <span class="stat-value" id="totalSize">0 MB</span>
                </div>
            </div>

            <!-- Documents View -->
            <div id="documentsView" class="documents-view active">
                <div id="documentsContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading documents...</p>
                    </div>
                </div>
            </div>

            <!-- Chunks View -->
            <div id="chunksView" class="chunks-view">
                <div class="chunks-header">
                    <div>
                        <div class="chunks-title" id="chunksTitle">Document Chunks</div>
                        <div style="font-size: 13px; color: #666; margin-top: 5px;" id="chunksSubtitle"></div>
                    </div>
                    <button class="btn-back" onclick="showDocuments()">← Back to Documents</button>
                </div>
                <div id="chunksContainer" class="chunks-list"></div>
            </div>
        </div>
    </div>

    <!-- Edit Chunk Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Chunk</h2>
                <button class="btn-close" onclick="hideEditModal()">×</button>
            </div>
            <form onsubmit="saveChunk(event)">
                <input type="hidden" id="editChunkId">
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="editContent" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="hideEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentDocId = null;
        let isSearchActive = false;
        let currentSearchQuery = '';
        let currentSearchType = 'keyword';

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            const fileName = document.getElementById('fileName');
            const uploadBtn = document.getElementById('uploadBtn');

            if (selectedFile) {
                fileName.textContent = selectedFile.name;
                uploadBtn.disabled = false;
            } else {
                fileName.textContent = 'No file selected';
                uploadBtn.disabled = true;
            }
        }

        async function uploadDocument() {
            if (!selectedFile) return;

            const uploadBtn = document.getElementById('uploadBtn');
            const progress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            uploadBtn.disabled = true;
            progress.classList.add('active');
            progressFill.style.width = '50%';
            progressText.textContent = 'Uploading and processing...';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/documents/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    progressFill.style.width = '100%';
                    progressText.textContent = `Complete! ${data.chunks_created} chunks created`;
                    showAlert('success', `${data.filename} uploaded successfully! ${data.chunks_created} chunks created.`);

                    // Reset form
                    document.getElementById('fileInput').value = '';
                    document.getElementById('fileName').textContent = 'No file selected';
                    selectedFile = null;

                    // Reload documents
                    setTimeout(() => {
                        progress.classList.remove('active');
                        progressFill.style.width = '0%';
                        loadDocuments();
                    }, 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('error', 'Upload failed: ' + error.message);
                progress.classList.remove('active');
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function loadDocuments() {
            const container = document.getElementById('documentsContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading documents...</p></div>';

            try {
                const response = await fetch('/api/documents');
                const data = await response.json();

                if (data.success) {
                    displayDocuments(data.documents);
                    updateStats(data.documents);
                } else {
                    container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${error.message}</p></div>`;
            }
        }

        function displayDocuments(documents) {
            const container = document.getElementById('documentsContainer');

            if (documents.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No documents yet</h3><p>Upload your first document to get started!</p></div>';
                return;
            }

            const docsHTML = documents.map(doc => {
                const sizeKB = (doc.file_size / 1024).toFixed(2);
                const date = new Date(doc.ingested_at).toLocaleString();

                return `
                    <div class="document-card" onclick="viewDocument('${doc.doc_id}')">
                        <div class="document-header">
                            <div class="document-title">${escapeHtml(doc.file_name)}</div>
                            <div class="document-actions" onclick="event.stopPropagation()">
                                <button class="btn-small btn-view" onclick="viewDocument('${doc.doc_id}')">View</button>
                                <button class="btn-small btn-delete" onclick="deleteDocument('${doc.doc_id}', '${escapeHtml(doc.file_name)}')">Delete</button>
                            </div>
                        </div>
                        <div class="document-meta">
                            <div class="meta-row">
                                <span class="meta-label">Chunks:</span>
                                <span>${doc.chunk_count}</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Size:</span>
                                <span>${sizeKB} KB</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Ingested:</span>
                                <span>${date}</span>
                            </div>
                            ${doc.metadata.original_filename ? `
                            <div class="meta-row">
                                <span class="meta-label">Original:</span>
                                <span>${escapeHtml(doc.metadata.original_filename)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="documents-grid">${docsHTML}</div>`;
        }

        function updateStats(documents) {
            const totalDocs = documents.length;
            const totalChunks = documents.reduce((sum, doc) => sum + doc.chunk_count, 0);
            const totalSize = documents.reduce((sum, doc) => sum + doc.file_size, 0);

            document.getElementById('totalDocs').textContent = totalDocs;
            document.getElementById('totalChunks').textContent = totalChunks;
            document.getElementById('totalSize').textContent = (totalSize / (1024 * 1024)).toFixed(2);
        }

        async function viewDocument(docId) {
            currentDocId = docId;

            // Hide documents view, show chunks view
            document.getElementById('documentsView').classList.remove('active');
            document.getElementById('chunksView').classList.add('active');

            const container = document.getElementById('chunksContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading chunks...</p></div>';

            try {
                const response = await fetch(`/api/documents/${docId}/chunks`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('chunksTitle').textContent = `Chunks for ${docId}`;
                    document.getElementById('chunksSubtitle').textContent = `${data.total} chunk${data.total !== 1 ? 's' : ''} total`;
                    displayChunks(data.chunks);
                } else {
                    container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${error.message}</p></div>`;
            }
        }

        function displayChunks(chunks) {
            const container = document.getElementById('chunksContainer');

            if (chunks.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No chunks found</h3></div>';
                return;
            }

            const chunksHTML = chunks.map(chunk => {
                const metadata = chunk.metadata || {};

                return `
                    <div class="chunk-card">
                        <div class="chunk-header">
                            <div class="chunk-id">ID: ${chunk.chunk_id}</div>
                            <div class="chunk-actions">
                                <button class="btn-small btn-edit" onclick="editChunk('${chunk.chunk_id}')">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteChunk('${chunk.chunk_id}')">Delete</button>
                            </div>
                        </div>
                        <div class="chunk-content">${escapeHtml(chunk.content)}</div>
                        <div class="chunk-metadata">
                            <div class="metadata-item">
                                <span class="metadata-label">Chunk:</span>
                                <span class="metadata-value">${(metadata.chunk_index || 0) + 1} / ${metadata.total_chunks || 'N/A'}</span>
                            </div>
                            ${metadata.section_title ? `
                            <div class="metadata-item">
                                <span class="metadata-label">Section:</span>
                                <span class="metadata-value">${escapeHtml(metadata.section_title)}</span>
                            </div>
                            ` : ''}
                            ${metadata.word_count ? `
                            <div class="metadata-item">
                                <span class="metadata-label">Words:</span>
                                <span class="metadata-value">${metadata.word_count}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = chunksHTML;
        }

        function showDocuments() {
            document.getElementById('chunksView').classList.remove('active');
            document.getElementById('documentsView').classList.add('active');
            currentDocId = null;
        }

        async function deleteDocument(docId, fileName) {
            if (!confirm(`Delete "${fileName}" and all its chunks?`)) return;

            try {
                const response = await fetch(`/api/documents/${docId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('success', 'Document deleted successfully');
                    loadDocuments();
                } else {
                    showAlert('error', 'Failed to delete: ' + data.error);
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            }
        }

        async function editChunk(chunkId) {
            try {
                const response = await fetch(`/api/chunks/${chunkId}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('editChunkId').value = chunkId;
                    document.getElementById('editContent').value = data.chunk.content;
                    document.getElementById('editModal').classList.add('active');
                } else {
                    showAlert('error', 'Failed to load chunk: ' + data.error);
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            }
        }

        async function saveChunk(event) {
            event.preventDefault();

            const chunkId = document.getElementById('editChunkId').value;
            const content = document.getElementById('editContent').value;

            try {
                const response = await fetch(`/api/chunks/${chunkId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (data.success) {
                    hideEditModal();
                    showAlert('success', 'Chunk updated successfully');
                    if (currentDocId) {
                        viewDocument(currentDocId);
                    }
                } else {
                    showAlert('error', 'Failed to update: ' + data.error);
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            }
        }

        async function deleteChunk(chunkId) {
            if (!confirm('Delete this chunk?')) return;

            try {
                const response = await fetch(`/api/chunks/${chunkId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('success', 'Chunk deleted successfully');
                    if (currentDocId) {
                        viewDocument(currentDocId);
                    }
                } else {
                    showAlert('error', 'Failed to delete: ' + data.error);
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            }
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function showAlert(type, message) {
            const alertId = type === 'success' ? 'alertSuccess' : 'alertError';
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.classList.add('active');

            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchType = document.getElementById('searchType').value;
            const searchText = searchInput.value.trim();

            if (!searchText) {
                showAlert('error', 'Please enter a search query');
                return;
            }

            currentSearchQuery = searchText;
            currentSearchType = searchType;
            isSearchActive = true;

            const container = document.getElementById('documentsContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Searching...</p></div>';

            try {
                let data;
                if (searchType === 'vector') {
                    const response = await fetch('/api/chunks/search-vector', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: searchText,
                            offset: 0,
                            limit: 100  // Get more results for search
                        })
                    });
                    data = await response.json();
                } else if (searchType === 'bm25') {
                    const response = await fetch('/api/chunks/search-bm25', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: searchText,
                            offset: 0,
                            limit: 100
                        })
                    });
                    data = await response.json();
                } else {
                    const response = await fetch(`/api/chunks?search=${encodeURIComponent(searchText)}&offset=0&limit=100`);
                    data = await response.json();
                }

                if (data.success) {
                    const showSimilarity = (searchType === 'vector');
                    displaySearchResults(data.chunks, showSimilarity, searchText);
                } else {
                    container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${error.message}</p></div>`;
            }
        }

        function displaySearchResults(chunks, showSimilarity, searchQuery) {
            const container = document.getElementById('documentsContainer');

            if (chunks.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No results found</h3><p>Try a different search query or search type.</p></div>';
                return;
            }

            // Group chunks by document
            const chunksByDoc = {};
            chunks.forEach(chunk => {
                const docId = chunk.metadata?.doc_id || 'unknown';
                if (!chunksByDoc[docId]) {
                    chunksByDoc[docId] = {
                        doc_title: chunk.metadata?.doc_title || docId,
                        chunks: []
                    };
                }
                chunksByDoc[docId].chunks.push(chunk);
            });

            let resultsHTML = `
                <div class="search-results-header">
                    <div>
                        <div class="search-results-title">Search Results for: "${escapeHtml(searchQuery)}"</div>
                        <div class="search-results-count">${chunks.length} chunk${chunks.length !== 1 ? 's' : ''} found across ${Object.keys(chunksByDoc).length} document${Object.keys(chunksByDoc).length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            `;

            // Display results grouped by document
            for (const [docId, docData] of Object.entries(chunksByDoc)) {
                resultsHTML += `
                    <div style="margin-bottom: 30px;">
                        <div style="background: #667eea; color: white; padding: 12px 20px; border-radius: 8px 8px 0 0; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            <span>📄 ${escapeHtml(docData.doc_title)}</span>
                            <span style="font-size: 13px; font-weight: normal;">${docData.chunks.length} matching chunk${docData.chunks.length !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="chunks-list" style="border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; padding: 15px;">
                `;

                docData.chunks.forEach(chunk => {
                    const metadata = chunk.metadata || {};
                    const similarity = chunk.similarity_score;
                    const distance = chunk.distance;

                    // Color code based on similarity
                    let badgeClass = 'similarity-low';
                    if (similarity >= 0.7) badgeClass = 'similarity-high';
                    else if (similarity >= 0.4) badgeClass = 'similarity-medium';

                    // Highlight search term in content (for keyword search)
                    let displayContent = escapeHtml(chunk.content);
                    if (!showSimilarity && searchQuery) {
                        const regex = new RegExp(`(${escapeHtml(searchQuery)})`, 'gi');
                        displayContent = displayContent.replace(regex, '<span class="highlight">$1</span>');
                    }

                    resultsHTML += `
                        <div class="chunk-card" style="margin-bottom: 15px;">
                            <div class="chunk-header">
                                <div class="chunk-id">
                                    <label style="display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" onchange="toggleSelectChunk('${chunk.chunk_id}', this.checked)">
                                        <span>ID: ${chunk.chunk_id}</span>
                                    </label>
                                    ${showSimilarity && similarity !== undefined ? `
                                        <span class="similarity-badge ${badgeClass}">
                                            ${(similarity * 100).toFixed(1)}% match
                                            ${distance !== undefined ? `<span class="distance-info">(dist: ${distance.toFixed(3)})</span>` : ''}
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="chunk-actions">
                                    <button class="btn-small btn-view" onclick="viewDocument('${metadata.doc_id}')">View Doc</button>
                                    <button class="btn-small btn-edit" onclick="editChunk('${chunk.chunk_id}')">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteChunkFromSearch('${chunk.chunk_id}')">Delete</button>
                                </div>
                            </div>
                            <div class="chunk-content">${displayContent}</div>
                            <div class="chunk-metadata">
                                <div class="metadata-item">
                                    <span class="metadata-label">Chunk:</span>
                                    <span class="metadata-value">${(metadata.chunk_index || 0) + 1} / ${metadata.total_chunks || 'N/A'}</span>
                                </div>
                                ${metadata.section_title ? `
                                <div class="metadata-item">
                                    <span class="metadata-label">Section:</span>
                                    <span class="metadata-value">${escapeHtml(metadata.section_title)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                resultsHTML += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = resultsHTML;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            isSearchActive = false;
            currentSearchQuery = '';
            loadDocuments();
        }

        async function deleteChunkFromSearch(chunkId) {
            if (!confirm('Delete this chunk?')) return;

            try {
                const response = await fetch(`/api/chunks/${chunkId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('success', 'Chunk deleted successfully');
                    // Re-run the search to update results
                    performSearch();
                } else {
                    showAlert('error', 'Failed to delete: ' + data.error);
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            }
        }

        // --- Retrieval Experimentation JS ---
        const selectedChunks = new Set();

        function toggleSelectChunk(chunkId, isChecked) {
            if (isChecked) selectedChunks.add(chunkId); else selectedChunks.delete(chunkId);
            document.getElementById('selectedCount').textContent = selectedChunks.size;
        }

        async function runExperimentSearch() {
            const query = document.getElementById('expQueryInput').value.trim();
            const method = document.getElementById('expMethod').value;
            const topK = parseInt(document.getElementById('expTopK').value || '20', 10);
            if (!query) { showAlert('error', 'Enter an experiment query.'); return; }
            const resBox = document.getElementById('expResults');
            resBox.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Running search...</p></div>';
            try {
                const resp = await fetch('/api/experiment/search_chunks', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, method, top_k: topK })
                });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Search failed');
                renderSearchExperimentResults(data.chunks, query, method, topK);
            } catch (e) {
                resBox.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`;
            }
        }

        function renderSearchExperimentResults(items, query, method, topK) {
            const resBox = document.getElementById('expResults');
            if (!items || items.length === 0) {
                resBox.innerHTML = '<div class="empty-state"><h3>No results</h3></div>';
                return;
            }
            let html = `
                <div class="search-results-header">
                    <div>
                        <div class="search-results-title">Experiment Search • ${method.toUpperCase()} • Top ${topK}</div>
                        <div class="search-results-count">Query: "${escapeHtml(query)}" • ${items.length} result(s)</div>
                    </div>
                </div>
                <div style="overflow:auto;">
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align:left; border-bottom:2px solid #eee;">
                            <th style="padding:8px;">#</th>
                            <th style="padding:8px;">Chunk ID</th>
                            <th style="padding:8px;">Score</th>
                            <th style="padding:8px;">Method</th>
                            <th style="padding:8px;">Search term</th>
                            <th style="padding:8px;">Preview</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach((it, idx) => {
                const preview = escapeHtml((it.content || '').slice(0, 200)) + ((it.content || '').length > 200 ? '...' : '');
                html += `
                    <tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:8px;">${idx+1}</td>
                        <td style="padding:8px; font-family:monospace;">${it.chunk_id}</td>
                        <td style="padding:8px;">${(it.score ?? 0).toFixed(4)}</td>
                        <td style="padding:8px;">${it.retrieval_method || ''}</td>
                        <td style="padding:8px;">${escapeHtml(it.search_term || '')}</td>
                        <td style="padding:8px;">${preview}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            resBox.innerHTML = html;
        }

        async function runExperimentRank() {
            const query = document.getElementById('expQueryInput').value.trim();
            const method = document.getElementById('expMethod').value;
            const topK = parseInt(document.getElementById('expTopK').value || '20', 10);
            if (!query) { showAlert('error', 'Enter an experiment query.'); return; }
            if (selectedChunks.size === 0) { showAlert('error', 'Select at least one chunk from search results.'); return; }
            const resBox = document.getElementById('expResults');
            resBox.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ranking selected chunks...</p></div>';
            try {
                const resp = await fetch('/api/experiment/rank_chunks', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, method, top_k: topK, chunk_ids: Array.from(selectedChunks) })
                });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Rank failed');
                renderRankExperimentResults(data.results, query, method, topK);
            } catch (e) {
                resBox.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`;
            }
        }

        function renderRankExperimentResults(items, query, method, topK) {
            const resBox = document.getElementById('expResults');
            if (!items || items.length === 0) {
                resBox.innerHTML = '<div class="empty-state"><h3>No items</h3></div>';
                return;
            }
            let html = `
                <div class="search-results-header">
                    <div>
                        <div class="search-results-title">Rank Selected • ${method.toUpperCase()} • Top ${topK}</div>
                        <div class="search-results-count">Query: "${escapeHtml(query)}" • Selected: ${items.length}</div>
                    </div>
                </div>
                <div style="overflow:auto;">
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align:left; border-bottom:2px solid #eee;">
                            <th style="padding:8px;">Chunk ID</th>
                            <th style="padding:8px;">Found</th>
                            <th style="padding:8px;">Rank</th>
                            <th style="padding:8px;">Score</th>
                            <th style="padding:8px;">Method</th>
                            <th style="padding:8px;">Search term</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.sort((a,b) => {
                if (a.found && b.found) return a.rank - b.rank;
                if (a.found && !b.found) return -1; if (!a.found && b.found) return 1; return 0;
            });
            items.forEach(it => {
                const foundBadge = it.found ? '<span class="similarity-badge similarity-high">FOUND</span>' : '<span class="similarity-badge similarity-low">NOT FOUND</span>';
                html += `
                    <tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:8px; font-family:monospace;">${it.chunk_id}</td>
                        <td style="padding:8px;">${foundBadge}</td>
                        <td style="padding:8px;">${it.rank === null || it.rank === undefined ? '-' : (it.rank + 1)}</td>
                        <td style="padding:8px;">${it.score === null || it.score === undefined ? '-' : it.score.toFixed(4)}</td>
                        <td style="padding:8px;">${it.retrieval_method || '-'}</td>
                        <td style="padding:8px;">${escapeHtml(it.search_term || '')}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            resBox.innerHTML = html;
        }

        // Load documents on page load
        loadDocuments();
    </script>
</body>
</html>
